<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css"
          integrity="sha384-UQiGfs9ICog+LwheBSRCt1o5cbyKIHbwjWscjemyBMT9YCUMZffs6UqUTd0hObXD" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./style.css">
    <style>
        #cards {
            display: flex;
            flex-direction: row;
            justify-content: center;
            flex-wrap: wrap;
            width: 300px;
            margin: auto;
        }

        #info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #disconnected {
            display: block;
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #303030;
            color: white;
            padding: 10px 40px 10px 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div id="disconnected" class="hidden">Sorry, you were disconnected. Refresh to play again.</div>

<div id="cards"></div>

<div id="info">
    <p>game: <span id="gameId"></span></p>
    <div id="players"></div>
    <p><button id="nosets" class="pure-button pure-button-primary">no sets (deal more)</button></p>
    <hr/>
    <p><a href="./" class="pure-button">start a new game</a>
    <form class="pure-form" onsubmit="join(this.id.value); return false;">
        <fieldset>
            <legend>join a game</legend>
            <label>
                <input type="number" name="id">
            </label>

            <button type="submit" class="pure-button">join</button>
        </fieldset>
    </form>
</div>

<svg version="1.1" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <pattern id="striped-red" class="pattern" x="10" y="10" width="20" height="20" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="10" height="200" style="stroke: none; fill: #E74C3C"></rect>
        </pattern>

        <pattern id="striped-purple" class="pattern" x="10" y="10" width="20" height="20" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="10" height="200" style="stroke: none;" fill="#9B59B6"></rect>
        </pattern>

        <pattern id="striped-green" class="pattern" x="10" y="10" width="20" height="20" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="10" height="200" style="stroke: none; fill: #2ECC71"></rect>
        </pattern>
    </defs>
</svg>
<div style="display: none;">
    <div class="shape" id="nut">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 210 106.058">
            <path d="M81.442,14.792c13.791,1.487,17.955,2.853,29.088,6.921c17.255,6.307,32.98,3.611,48.464-4.519c4.869-2.557,9.379-5.785,14.096-8.64c11.231-6.794,21.987-3.746,27.416,8.255c7.255,16.35,5.223,31.92-2.491,47.142c-13.492,26.623-38.203,34.367-64.534,29.43c-14.679-2.97-28.883-8.259-43.537-11.403c-17.457-3.745-33.689,.502-48.567,10.238c-3.548,2.321-7.216,4.498-10.981,6.443c-11.57,5.98-20.215,2.23-23.625-10.337C1.708,69.282,7.989,53.525,19.427,39.053C33.758,20.92,52.818,12.638,81.442,14.792z"></path>
        </svg>
    </div>
    <div class="shape" id="diamond">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 223.621 104.493">
            <polygon points="211.811,52.247 111.811,98.974 11.811,52.247 111.811,5.519"></polygon>
        </svg>
    </div>
    <div class="shape" id="pill">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 210 101.429">
            <path d="M159.286,96.429c25.247,0,45.714-20.467,45.714-45.714S184.533,5,159.286,5H50.714C25.467,5,5,25.467,5,50.714s20.467,45.714,45.714,45.714H159.286z"></path>
        </svg>
    </div>
</div>
<script>
    var url;
    if (location.protocol === 'https:') {
        url = 'wss://';
    } else {
        url = 'ws://';
    }
    url += location.host + location.pathname + 'ws';
    var ws = new WebSocket(url);

    var cards = document.getElementById('cards');
    var gameId = document.getElementById('gameId');
    document.getElementById('nosets').onclick = function () {
        ws.send(JSON.stringify({type: 'nosets'}))
    };

    var nut = document.getElementById('nut');
    var diamond = document.getElementById('diamond');
    var pill = document.getElementById('pill');

    var map = {};
    var selected = [];
    var wasJustMoving = false;

    function addEventListeners(position, node) {
        node.addEventListener('touchend', selectHandler(position, node));
        node.addEventListener('touchmove', function () {
            wasJustMoving = true;
        });
        node.addEventListener('click', selectHandler(position, node));
    }

    function selectHandler(location, node) {
        return function (event) {
            // prevent dragging causing selection
            if (wasJustMoving) {
                wasJustMoving = false;
                return;
            }
            event.stopPropagation();
            event.preventDefault();
            if (event.handled === true) {
                return;
            }
            event.handled = true;
            // see if we're already selected
            var index = selected.indexOf(location);
            if (index >= 0) {
                selected.splice(index, 1);
                node.classList.remove('selected');
            } else {
                selected.push(location);
                node.classList.add('selected');
            }
            if (selected.length === 3) {
                // send to backend for verification
                for (var s = 0; s < selected.length; s++) {
                    map[selected[s]].classList.remove('selected');
                }
                ws.send(JSON.stringify({type: "play", play: selected}));
                selected = [];
            }
            console.log(selected);
        }
    }

    function join(id) {
        ws.send(JSON.stringify({type: "join", join: id}));
    }

    ws.onopen = function (e) {
        if (location.hash && location.hash.length > 1) {
            join(location.hash.split('#')[1]);
        } else {
            join('');
        }
    };

    ws.onmessage = function (e) {
        var node;
        var data = JSON.parse(e.data);
        switch (data.type) {
            case 'meta':
                gameId.textContent = data.GameId;
                updatePlayers(data.Players);
                location.hash = gameId.textContent;
                break;
            case 'all':
                while (cards.firstChild) {
                    cards.removeChild(cards.firstChild);
                }
                map = {};
            // fallthrough
            case 'update':
                selected = [];
                gameId.textContent = data.GameId;
                updatePlayers(data.Players);
                location.hash = gameId.textContent;

                for (var i = 0; i < data.updates.length; i++) {
                    var update = data.updates[i];
                    // grab the node from the lookup map
                    node = map[update.location];
                    if (node) {
                        // clear existing card, if any
                        while (node.firstChild) {
                            node.removeChild(node.firstChild);
                        }
                    } else {
                        // create it if it doesn't exist
                        node = cards.appendChild(document.createElement('span'));
                        node.setAttribute('id', update.location);
                        addEventListeners(update.location, node);
                        map[update.location] = node;
                    }
                    var shape;
                    switch (update.card.shape) {
                        case 'pill':
                            shape = pill;
                            break;
                        case 'diamond':
                            shape = diamond;
                            break;
                        case 'nut':
                            shape = nut;
                            break;
                    }
                    for (var j = 0; j < update.card.amount; j++) {
                        node.appendChild(shape.cloneNode(true));
                    }
                    node.className = 'card select-pop animate-in ' + update.card.pattern + " " + update.card.color;
                }
                break;
            default:
                console.log("unknown type", data.type);
        }
    };

    ws.onerror = function (e) {
        console.log('error', e);
    };

    ws.onclose = function (e) {
        document.getElementById('disconnected').className = '';
    };

    var players = document.getElementById('players');
    var cachedPlayers = [];
    function updatePlayers(playerData) {
      if (cachedPlayers === playerData) {
        return;
      }
      while (players.firstChild) {
        players.removeChild(players.firstChild);
      }
      for(var i=0; i<playerData.length; i++) {
        var p = document.createElement('p');
        p.textContent = 'Player ' + playerData[i].Id + ': ' + playerData[i].Score;
        players.appendChild(p);
      }
    }
</script>
</body>
</html>
